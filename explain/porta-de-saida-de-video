Porta de Saída de Vídeo DE1-SoC

O Computador DE1-SoC inclui uma porta de saída de vídeo conectada ao controlador VGA integrado na placa, que pode ser conectada a um monitor VGA padrão. A porta de saída de vídeo suporta uma resolução de tela de 640 × 480. A imagem exibida pela porta de saída de vídeo é derivada de duas fontes: um buffer de pixels e um buffer de caracteres.

Buffer de Pixels
O buffer de pixels para a porta de saída de vídeo armazena os dados (cores) para cada pixel que será exibido. Conforme ilustrado na Figura 18, o buffer de pixels fornece uma resolução de imagem de 320 × 240 pixels, com a coordenada 0,0 localizada no canto superior esquerdo da imagem. Como a porta de saída de vídeo suporta a resolução de tela de 640 × 480, cada um dos valores de pixel no buffer de pixels é replicado nas dimensões x e y quando está sendo exibido na tela.

A Figura 19a mostra que cada cor de pixel é representada como uma semipalavra de 16 bits, com cinco bits para os componentes azul e vermelho, e seis bits para o verde. Como mostrado na parte b da Figura 19, os pixels são endereçados no buffer de pixels usando a combinação de um endereço base e um deslocamento x, y. No Computador DE1-SoC, o endereço padrão do buffer de pixels é 0xC8000000, que corresponde ao endereço de início da memória interna da FPGA. Usando este esquema, o pixel na localização 0,0 tem o endereço 0xC8000000, o pixel 1,0 tem o endereço base + (00000000 000000001 0)2 = 0xC8000002, o pixel 0,1 tem o endereço base + (00000001 000000000 0)2 = 0xC8000400, e o pixel na localização 319,239 tem o endereço base + (11101111 100111111 0)2 = 0xC803BE7E.

Você pode criar uma imagem escrevendo valores de cor nos endereços de pixel conforme descrito acima. Um controlador de buffer de pixels dedicado lê continuamente esses dados de pixel em endereços sequenciais na memória correspondente para exibição na tela. Você pode modificar os dados de pixel a qualquer momento, simplesmente escrevendo nos endereços de pixel. Assim, uma imagem pode ser alterada mesmo quando está sendo exibida. No entanto, também é possível evitar alterações no buffer de pixels enquanto ele está sendo exibido, usando o conceito de duplo buffer. Neste esquema, dois buffers de pixels estão envolvidos, chamados buffers frontal e traseiro, descritos abaixo.

Resampling RGB
O Computador DE1-SoC contém um Reamostrador RGB para converter fluxos de vídeo entre formatos de cor RGB. A leitura do registrador de Status de 32 bits no endereço 0xFF203010 fornece informações sobre alfa/sem alfa, cor/escala de cinza e modo para os formatos de entrada e saída. O formato de entrada para o fluxo de vídeo do Computador DE1-SoC é 0x14, que corresponde a sem alfa, cor, RGB de 16 bits (5 bits vermelho, 6 bits verde, 5 bits azul).

Para mais informações, o leitor deve consultar a documentação online do módulo de vídeo, Núcleos IP de Vídeo para Placas da Série DE da Intel, disponível no site do Programa Universitário de FPGA da Intel.

Duplo Buffer
Como mencionado acima, um controlador de buffer de pixels lê dados do buffer de pixels para que possam ser exibidos na tela. Este controlador de buffer de pixels inclui uma interface de programação na forma de um conjunto de registradores, conforme ilustrado na Tabela 2. O registrador no endereço 0xFF203020 é chamado de registrador de Buffer, e o registrador no endereço 0xFF203024 é o registrador de Backbuffer. Cada um desses registradores armazena o endereço de início de um buffer de pixels. O registrador de Buffer contém o endereço do buffer de pixels que está sendo exibido na tela. Como mencionado acima, na configuração padrão do Computador DE1-SoC, este registrador de Buffer é definido como o endereço 0xC8000000, que aponta para o início da memória interna da FPGA. O valor padrão do registrador de Backbuffer também é 0xC8000000, o que significa que há apenas um buffer de pixels. Mas o software pode modificar o endereço armazenado no registrador de Backbuffer, criando assim um segundo buffer de pixels. O buffer de pixels pode estar localizado na memória SDRAM no Computador DE1-SoC, que tem o endereço base 0xC0000000. Note que o buffer de pixels não pode estar localizado na memória DDR3 no Computador DE1-SoC, porque o controlador de buffer de pixels não está conectado à memória DDR3. Uma imagem pode ser desenhada no segundo buffer escrevendo nos seus endereços de pixel. Esta imagem não é exibida na tela até que uma troca de buffer de pixels seja realizada, como explicado abaixo.

Uma troca de buffer de pixels é causada escrevendo o valor 1 no registrador de Buffer. Esta operação de escrita não modifica diretamente o conteúdo do registrador de Buffer, mas faz com que os conteúdos dos registradores de Buffer e Backbuffer sejam trocados. A operação de troca não acontece imediatamente; ocorre no final de um ciclo de desenho da tela, após o último pixel no canto inferior direito ter sido exibido. Este instante de tempo é referido como o tempo de sincronização vertical, e ocorre a cada 1/60 segundos. O software pode verificar o valor do bit S no registrador de Status, no endereço 0xFF20302C, para ver quando a sincronização vertical aconteceu. Escrever o valor 1 no registrador de Buffer faz com que S seja definido como 1. Em seguida, quando a troca dos registradores de Buffer e Backbuffer for concluída, S é redefinido para 0.

Em uma aplicação típica, o controlador de buffer de pixels é usado da seguinte forma. Enquanto a imagem contida no buffer de pixels apontado pelo registrador de Buffer está sendo exibida, uma nova imagem é desenhada no buffer de pixels apontado pelo registrador de Backbuffer. Quando esta nova imagem estiver pronta para ser exibida, uma troca de buffer de pixels é realizada. Então, o buffer de pixels que agora é apontado pelo registrador de Backbuffer, que já foi exibido, é limpo e a próxima nova imagem é desenhada. Desta forma, a próxima imagem a ser exibida é sempre desenhada no buffer de pixels "traseiro", e os dois ponteiros de buffer de pixels são trocados quando a nova imagem estiver pronta para ser exibida. Cada vez que uma troca é realizada, o software precisa sincronizar com a porta de saída de vídeo aguardando até que o bit S no registrador de Status se torne 0.

Como mostrado na Tabela 2, o registrador de Status contém informações adicionais além do bit S. Os campos n e m fornecem o número de bits de endereço usados para as coordenadas de pixel X e Y, respectivamente. O campo BS especifica o número de bits de dados por símbolo menos um. O campo SB especifica o número de símbolos por batida menos um. O campo A permite a seleção de duas maneiras diferentes de formar endereços de pixel. Se configurado com A = 0, então o controlador de pixel espera que os endereços contenham os campos X e Y, como usamos nesta seção. Mas se A = 1, então o controlador espera que os endereços sejam valores consecutivos começando em 0 e terminando no número total de pixels menos um. O campo EN é usado para ativar ou desativar o controlador DMA. Se este bit for definido como 0, o controlador DMA será desligado.

Na Tabela 2, os valores padrão dos campos do registrador de status no Computador DE1-SoC são usados ao formar endereços de pixel. Os padrões são n = 9, m = 8 e A = 0. Se o controlador de buffer de pixels for alterado para fornecer valores diferentes desses campos, então a forma como os endereços de pixel são formados deve ser modificada de acordo. A interface de programação também inclui um registrador de Resolução, mostrado na Tabela 2, que contém a resolução X e Y do(s) buffer(s) de pixels.

Buffer de Caracteres
O buffer de caracteres para a porta de saída de vídeo é armazenado na memória interna da FPGA na placa DE1-SoC. Como ilustrado na Figura 20a, o buffer fornece uma resolução de 80 × 60 caracteres, onde cada caractere ocupa um bloco de pixels de 8 × 8 na tela. Os caracteres são armazenados em cada uma das localizações mostradas na Figura 20a usando seus códigos ASCII; quando esses códigos de caracteres são exibidos no monitor, o buffer de caracteres gera automaticamente o padrão correspondente de pixels para cada caractere usando uma fonte integrada. A parte b da Figura 20 mostra que os caracteres são endereçados na memória usando a combinação de um endereço base, que tem o valor 0xC9000000, e um deslocamento x, y. Usando este esquema, o caractere na localização 0,0 tem o endereço 0xC9000000, o caractere 1,0 tem o endereço base + (000000 0000001)2 = 0xC9000001, o caractere 0,1 tem o endereço base + (000001 0000000)2 = 0xC9000080, e o caractere na localização 79,59 tem o endereço base + (111011 1001111)2 = 0xC9001DCF.

Uso da Porta de Saída de Vídeo com Código C
Um fragmento de código C que usa os buffers de pixels e caracteres é mostrado na Listagem 18. O primeiro loop for na figura desenha um retângulo no buffer de pixels usando a cor pixel_color. O retângulo é desenhado usando as coordenadas x1, y1 e x2, y2. O segundo loop while na figura escreve uma string de caracteres terminada em nulo apontada pela variável text_ptr no buffer de caracteres nas coordenadas x, y. O código na Listagem 18 está incluído no programa de exemplo chamado Video que é distribuído com o Programa Monitor FPGA da Intel.
